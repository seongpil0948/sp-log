# 개요

NextJs 프레임워크를 사용한다면, Vercel을 사용하여 프로젝트를 배포할 수 있습니다.  
Vercel은 NextJs 프레임워크와 함께 사용하기에 최적화된 서비스입니다.  
Vercel을 사용하면 프로젝트를 빠르게 배포하고, 빌드 및 배포 과정을 자동화할 수 있습니다.   

## Fdi
[vercel-fdi](https://vercel.com/blog/framework-defined-infrastructure) Framework-defined infrastructure 은 프레임워크에 최적화된 인프라스트럭처를 제공하는 개념입니다.  
베스트는 프레임워크를 제작한 회사가 프레임워크와 함께 사용할 인프라를 제공하며 CI/CD, Provisioning, Monitoring, Security 등 최적화된 [Iac](https://en.wikipedia.org/wiki/Infrastructure_as_code)의 진화된 형태입니다.   
즉 빌드간 코드를 분석하여, 그에 맞는 인프라를 제공하는 방안은 NextJS 를 만든 사람의 서비스를 이용하는 개발자의 가히 infrastructureless로 느낄 수 있게합니다.  

### 무엇을?: 어떤 서비스를 제공하는가
- 네트워크 장비 및 환경 설정
- 웹 등 어플리케이션 서버
- 데이터베이스, 메세지 큐등


### 왜?: 사용해야하는가
기존 호스팅 서비스는 사용자가 서비스를 이용할 때, 서비스에 맞는 인프라를 선택하고, 설정해야합니다.   
이는 여러 이슈들이 있습니다.
- cafe24의 DB SSH 보안 이슈가 있었죠
- AWS의 각종 Credential들을 중급 이상의 개발자들이 관리해야 하며 관련 이슈가 즐비합니다.  
- 커지는 스케일, 트래픽에 따라 컴퓨팅 리소스를 증설하거나, 줄이는 작업이 필요합니다.

Vercel은 이러한 이슈들을 해결하기 위해 Fdi로서 프레임워크에 최적화된 인프라를 제공합니다.  
물론 컴퓨팅 리소스를 증설하거나, 줄이는 작업도 자동화되어 있습니다.  





## 하지만: 주의사항
<AlertText title="하지만!" color="warn">
  AWS, GCP 등과 같이 클라우드 서비스를 사용할 때에는 아키텍처를 이해하고, 서비스를 사용하는 것이 중요합니다.    
  사전 학습이 없다면, 크게는 어플리케이션을 다시 만들어야 할 수도 있습니다.  
</AlertText>

### 예시 상황
vercel 은 dashboard 기능중 배포된 파일들을 Tree 형태로 제공하는 기능이 있습니다.  
이에 힌트를 얻어 간단히 markdown 파일들을 스캔하여 검색을 제공하는 간단한 검색엔진을 만들었습니다.
```ts
export async function initializedSearchBasic(engine: SearchEngineCommon) {
  engine.clear();
  const libTree = dirTree(
    "app",
    { exclude: /home|[id]]/ },
    undefined,
    (item) => {
      return isDocName(item);
    }
  );
  if (!libTree) throw new Error("dirTree is empty");
  const treeList = toList(libTree);

  for (const link of treeList) {
    // read file content
    const fileContent = await readFile(link.path, "utf-8");
    const href = pathToHref(link.path);

    const obj = splitContent(fileContent);
    for (const { title, content } of obj) {
      engine.addDoc({ href, content, title });
    }
  }
}
```

`build`, `preview` 과정에서 문제가 없지만, 배포 후 에러가 발생합니다.
```
⨯ Error: dirTree is empty
    at m (/var/task/.next/server/app/api/search/route.js:1:1794)
...
```
원인은 무엇이고, 어떻게 해결해야 할까요?  
이는 Vercel의 빌드 과정을 이해하지 못한 결과입니다.  
Vercel은 빌드 과정에서 `app` 디렉토리를 빌드하고, 배포합니다.   
사실 프론트엔지니어라면 당연하다 할 수 있지만 저의 경우는 대시보드에서 Output을 확인하지 못하고 있었습니다.  
<CodeHeader text="프로젝트 대시보드 - Deployments - Source" />
![vercel-deploy-source](/docs/vercel/architecture/dashboard-source.png)  

상단 `Output` 버튼을 클릭하면, 빌드된 파일들을 확인할 수 있습니다.  
  
![vercel-deploy-source](/docs/vercel/architecture/dashboard-output.png)  

[applying-framework-defined-infrastructure](https://vercel.com/blog/framework-defined-infrastructure#applying-framework-defined-infrastructure)에서는
NextJs를 기준으로 파일과 인프라 구성요소를 매핑하여, 이해를 돕습니다.  
사실 Output 단락에서, 오류의 원인을 유추할 수 있지만 NextJs는 "디렉터리 구조의 파일을 웹 애플리케이션의 URL에 매핑하는 파일 기반 라우터를 사용하며 라우팅 경로에 따라 올바른 인프라 기능을 제공합니다." 라고 설명합니다.    
와닿지 않는다면 [applying-framework-defined-infrastructure](https://vercel.com/blog/framework-defined-infrastructure#applying-framework-defined-infrastructure)를 반드시 한번 읽어보세요    
<AlertText title="문서 안읽으실거라면!" color="info">
  정적빌드를 최대화하여, Function 자원을 최소화하세요 (빌드된 파일을 CDN에 캐싱하여, 빠른 속도를 제공합니다.)
</AlertText>


## Vercel Functions
Vercel은 기본적으로 API를 Serverless Functions 형태로 제공하고 이는 AWS Lambda, Google Cloud Functions와 같은 서버리스 환경에서 함수를 실행할 수 있도록 해줍니다.     
<AlertText title="FDI" color="info">
  FDI는 반복적인 serverless function 생성을 최소화합니다.(자동화)
</AlertText>

### 사용처
- Streaming: 채팅등 실시간, AI 등 데이터 정제, 금융 작업등 transaction
- Auth: 인증, 권한 부여 로직
- Data Processing: 이미지/비디오등 클라이언트에서 처리하기 어려운 퍼포먼스 작업

함수 목록은 `Logs - Filter by Function`, `Usage - Serverless Functions` 에서 확인할 수 있습니다.   


## Reference
- https://vercel.com/blog/framework-defined-infrastructure
- https://vercel.com/docs/functions
- https://vercel.com/docs/edge-network/overview