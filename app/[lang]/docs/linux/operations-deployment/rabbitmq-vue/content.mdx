# connect RabbitMQ using websocket

## What is RabbitMQ?
RabbitMQ는 AMQP(Advanced Message Queuing Protocol)를 구현한 오픈소스 메시지 브로커 소프트웨어입니다.
통상 Pub/Sub 패턴을 요구하는 서비스에서 사용됩니다. (ex. 채팅 서비스, 알림 서비스 등)  

## Why do we need RabbitMQ, RabbitMQ의 활용 분야?
RabbitMQ는 다양한 분야에서 활용될 수 있습니다.
- 마이크로서비스 아키텍처: 마이크로서비스 간 통신에 RabbitMQ를 사용하여 느슨하게 결합된 시스템을 구축할 수 있습니다.
- 이벤트 구동 아키텍처: 이벤트 구축 아키텍처에서 RabbitMQ를 사용하여 이벤트를 효율적으로 전달하고 처리할 수 있습니다.
- 분산 시스템: 분산 시스템에서 데이터 동기화, 작업 큐, 메시지 브로딩 등 다양한 용도로 RabbitMQ를 사용할 수 있습니다.
- 실시간 데이터 처리: 실시간 데이터 처리 시스템에서 RabbitMQ를 사용하여 데이터를 효율적으로 수집하고 처리할 수 있습니다.

## How to install RabbitMQ?
RabbitMQ는 다양한 운영체제에서 다른 방식으로 설치할 수 있습니다.
설치는 공식문서를 참고하여 진행하시기 바랍니다.
- [RabbitMQ Installation Guide](https://www.rabbitmq.com/docs/download)

### Caution
- RabbitMQ는 Erlang 기반으로 동작합니다. 따라서 Erlang에 대한 종속성이 있습니다.
- OS, version 등에 따라 설치 가능여부와 distribution이 다릅니다. 유의하시기 바랍니다.

### Check RabbitMQ status
설치가 완료되면 RabbitMQ 서버는 자동으로 실행됩니다. 
정상적으로 설치된 경우, 상태를 확인할 수 있습니다.
```bash
sudo systemctl status rabbitmq-server.service 
● rabbitmq-server.service - RabbitMQ broker
     Loaded: loaded (/lib/systemd/system/rabbitmq-server.service; disabled; vendor preset: enabled)
     Active: active (running) since Fri 2024-04-05 01:53:18 UTC; 21s ago
   Main PID: 365429 (beam.smp)
      Tasks: 24 (limit: 18438)
     Memory: 74.9M
     CGroup: /system.slice/rabbitmq-server.service
             ├─365429 /usr/lib/erlang/erts-14.2.3/bin/beam.smp -W w -MBas ageffcbf -MHas ageffcbf -MBlmbcs 512 -MHlmbcs 512 -MMmcs 30 -pc unicode -P 1048576 -t 5000000 -stbt db -zdbbl 128000 -sbwt none -sbwtdcpu>
             ├─365457 erl_child_setup 32768
             ├─365479 /usr/lib/erlang/erts-14.2.3/bin/inet_gethost 4
             ├─365480 /usr/lib/erlang/erts-14.2.3/bin/inet_gethost 4
             └─365499 /bin/sh -s rabbit_disk_monitor

Apr 05 01:53:17 sp rabbitmq-server[365429]:   Release series support status: supported
Apr 05 01:53:17 sp rabbitmq-server[365429]:   Doc guides:  https://www.rabbitmq.com/docs/documentation
Apr 05 01:53:17 sp rabbitmq-server[365429]:   Support:     https://www.rabbitmq.com/docs/contact
Apr 05 01:53:17 sp rabbitmq-server[365429]:   Tutorials:   https://www.rabbitmq.com/tutorials
Apr 05 01:53:17 sp rabbitmq-server[365429]:   Monitoring:  https://www.rabbitmq.com/docs/monitoring
Apr 05 01:53:17 sp rabbitmq-server[365429]:   Logs: /var/log/rabbitmq/rabbit@sp.log
Apr 05 01:53:17 sp rabbitmq-server[365429]:         <stdout>
Apr 05 01:53:17 sp rabbitmq-server[365429]:   Config file(s): (none)
Apr 05 01:53:18 sp rabbitmq-server[365429]:   Starting broker... completed with 0 plugins.
Apr 05 01:53:18 sp systemd[1]: Started RabbitMQ broker.
```
기본 로그 위치는 `/var/log/rabbitmq/` 입니다.
- `startup_log`와 `startup_err` 파일등 다양한 로그 파일이 있습니다.
```bash
ls /var/log/rabbitmq
```
만약 RabbitMQ 서버가 실행되지 않는다면, 다음 명령을 실행하여 서버를 시작할 수 있습니다.
```bash
# sudo systemctl restart rabbitmq-server.service
sudo systemctl start rabbitmq-server.service
```
에러가 발생한다면, 시스템 로그를 확인하시기 바랍니다.
```bash
journalctl -xe | grep rabbitmq
# or
cat /var/log/rabbitmq/startup_err
# or
journalctl -p err -S "1 hour ago" -f -u rabbitmq-server.service
```
필자의 경우 `epmd` host에 연결이 실패했다는 에러가 발생했습니다.  
(`epmd`는 Erlang Port Mapper Daemon으로, Erlang 노드 간 통신을 위한 포트 매핑을 제공합니다.)
```bash
# check epmd process status
$ ps aux | grep epmd
rabbitmq  291987  0.0  0.0   7940  2576 ?        S    Apr04   0:00 /usr/lib/erlang/erts-14.2.3/bin/epmd -daemon
username  368397  0.0  0.0   8160  2460 pts/0    S+   02:10   0:00 grep --color=auto epmd
# check process port from process id
$ sudo ss -lptn | grep epmd
LISTEN    0         4096               0.0.0.0:4369             0.0.0.0:*        users:(("epmd",pid=291987,fd=3))                                               
LISTEN    0         4096                  [::]:4369                [::]:*        users:(("epmd",pid=291987,fd=4)) 
```
프로세스는 실행되고 있었으므로, 다른 이유로 인해 실패한 것으로 보입니다.
```bash
$ sudo rabbitmqctl status
```
필자는 에러로그로 부터 node name이 잘못 설정되어 있었음을 확인했습니다.
`192.168.0.` 과 같이 IP 형식으로 호스트 이름을 설정하면 192까지 node name으로 인식합니다.  
따라서 호스트 이름을 `sp`로 변경하고 서버를 재시작하였습니다.
```bash
$ sudo hostnamectl set-hostname sp
$ sudo systemctl restart rabbitmq-server.service
```

정상 동작 확인
```bash
$ sudo rabbitmqctl status
Status of node rabbit@sp ...
Runtime

OS PID: 365429
OS: Linux
Uptime (seconds): 1373
Is under maintenance?: false
RabbitMQ version: 3.13.1
RabbitMQ release series support status: supported
Node name: rabbit@sp
Erlang configuration: Erlang/OTP 26 [erts-14.2.3] [source] [64-bit] [smp:2:2] [ds:2:2:10] [async-threads:1] [jit:ns]
Crypto library: OpenSSL 1.1.1f  31 Mar 2020
Erlang processes: 291 used, 1048576 limit
Scheduler run queue: 1
Cluster heartbeat timeout (net_ticktime): 60
```

서버가 재시작되었을 때 자동으로 실행되도록 설정하려면 다음 명령을 실행하십시오.
```bash
sudo systemctl enable rabbitmq-server.service
```

## Setup RabbitMQ

### RabbitMQ Plugins
RabbitMQ는 기본적으로 `guest` 사용자로 접속할 수 있습니다.
```bash
$ sudo rabbitmqctl list_users
Listing users ...
guest	[administrator]
```
보안을 위해, 신규 사용자 추가 후, 삭제하겠습니다.
```bash
# create new user
$ sudo rabbitmqctl add_user root password
# grant user administrator permission
$ sudo rabbitmqctl set_user_tags root administrator
$ sudo rabbitmqctl delete_user guest
$ sudo rabbitmqctl list_users
Listing users ...
user	tags
root	[administrator]
```

이제 RabbitMQ Plugin들을 활성화하겠습니다.
- https://www.rabbitmq.com/docs/management
- https://www.rabbitmq.com/docs/web-mqtt
```bash
$ sudo rabbitmq-plugins enable rabbitmq_management
$ sudo rabbitmq-plugins enable rabbitmq_web_mqtt
```
필자의 경우 `192.168.0.100` 서버에 설치하였습니다. 기본 포트는 `15672` 입니다.
브라우저에서 다음 URL로 접속하여 확인할 수 있습니다.
http://192.168.0.100:15672/
- username: root
- password: password

제가 사용할 rabbitmq 설정 요소는 다음과 같습니다.
- exchange: `amq.topic`
  - 라우팅 키에 모든 메세지를 전달할 것이 아니라 특정 토픽에 매칭되는 메세지만 전달합니다.
  - refer: https://phsun102.tistory.com/145

- queue(routing key): `locationQueue`, `workerQueue`
  - 메세지를 저장하는 큐입니다.
- topic: `location`, `worker`
  - 라우팅 키입니다.

### ⚠ All stable feature flags must be enabled after completing an upgrade.대처
```bash
sudo rabbitmqctl enable_feature_flag all
```

### Declare Exchange, Queue, Binding from CLI
CLI :15672/cli/rabbitmqadmin 에서 다운받은 python을 실행하면 사용할 수 있습니다. 
```bash
# create exchange
$ sudo rabbitmqadmin declare exchange name=amq.topic type=topic
# create queue
$ sudo rabbitmqadmin declare queue name=locationQueue durable=true
$ sudo rabbitmqadmin declare queue name=workerQueue durable=true
# bind queue
$ sudo rabbitmqadmin declare binding source=amq.topic destination=locationQueue routing_key=location
$ sudo rabbitmqadmin declare binding source=amq.topic destination=workerQueue routing_key=worker
```
위 코드는 참고용으로 실제로 실행하지 않았습니다.  
실제로는 RabbitMQ Web Console에서 진행하였습니다.
간단히 설명하자면, `exchange`는 메세지를 받아들이는 곳이고, `queue`는 메세지를 저장하는 곳입니다.
1. Exchanges 탭에서 `Add a new exchange`를 클릭하여 `amq.topic`을 생성합니다.
   1. `name` : `amq.topic`
   2. `type` : `topic`
2. Queues 탭에서 `Add a new queue`를 클릭하여 `locationQueue`, `workerQueue`를 생성합니다.
   1. `name` : `locationQueue`, `workerQueue`
   2. `durable` : 체크
3. 각 Queue 상세 페에지에 들어가서 `Add binding from exchange`를 클릭하여 `amq.topic`과 `location`, `worker`를 알맞게 설정합니다.
   1. `source` : `amq.topic`
   2. `destination` : `locationQueue`, `workerQueue`
   3. `routing key` : `location`, `worker`


## Connect Vue.js to RabbitMQ
해당 예제는 `mqtt` 라이브러리를 사용합니다.  
이미 완성된 코드를 사용하기 때문에, 각자 프로젝트에 맞게 수정하여 사용하시기 바랍니다.  

### Install mqtt
```bash
npm install mqtt
```

### declare mqtt client - composition API
아래 예제는 composition API를 사용하여 mqtt client를 선언합니다.  

```typescript
// composables/mqtt.ts
import mqtt from 'mqtt';
import { ref } from 'vue';


interface Props<Message, Topics extends readonly [string, string]> {
  readonly config: mqtt.IClientOptions
  readonly onMessage: (topic: Topics[number], message: Message) => void
  readonly topics: Topics
}

export function useMqtt<Message, Topics extends readonly [string, string] = ['resource', 'worker']>(p: Props<Message, Topics>) {
  const { config, onMessage, topics } = p;
  const { host, port, ...option } = config;
  const connected = ref(false)


  const ignite = () => {
    const client = mqtt.connect(`ws://${host}:${port}/ws`, option);

    client.on('connect', () => {
      connected.value = true;
      console.log('MQTT ' + host + '에 연결되었습니다.');
      // 토픽 구독
      topics.forEach((topic) => {
        client.subscribe(topic, (err, granted) => {
          if (err) {
            console.error('토픽 ' + topic + ' 구독 실패 : ', err);
            return;
          }

          console.log('토픽 ' + topic + ' 구독 성공. granted: ', granted);
        });
      })

    });

    client.on('error', (err) => {
      console.error("MQTT 연결 오류 :", err)
    })

    client.on('offline', () => {
      console.log('MQTT 브로커와 연결이 끊어졌습니다(오프라인).');
    })



    client.on('message', (topic, msg) => {
      try {
        onMessage(topic as Topics[number], JSON.parse(msg.toString()));
      } catch (e) {
        console.error(topic, '토픽 메시지 파싱 오류:', e)
      }
    });

    // 연결 종료 시 이벤트 처리
    client.on('end', () => {
      connected.value = false;
      console.log('MQTT 브로커 연결 종료.');
    });

    const dispose = () => {
      console.log('MQTT 연결 종료')
      client.end()
    }

    return {
      client,
      dispose,
    }
  }

  return {
    ignite
  }

}
```

### usage mqtt client
```typescript
// App.vue
const topics = Object.freeze(["location", "worker"] as const);
const { ignite } = useMqtt<Resources | TWorker, typeof topics>({
  config: {
    clientId: "client-" + Math.random().toString(16).substring(2, 8),
    host: "192.168.0.100",
    port: 15675,
    username: "root",
    password: "password",
  },
  topics,
  onMessage(topic, message) {
    console.log("in onMessage topic: ", topic, "message: ", message);
    if (topic === "location") {
      if (isResources(message)) {
        setResources(message);
      } else throw new Error("올바르지 않은 메시지 형식입니다");
    } else if (topic === "worker") {
      if (isWorker(message)) {
        handleUpdateWorker(message.document);
      } else throw new Error("올바르지 않은 메시지 형식입니다");
    }
  },
});

const { dispose } = ignite();
onBeforeUnmount(() => {
  dispose();
});
```


## Conclusion
이상으로 RabbitMQ를 사용하여 Vue.js와 연결하는 방법을 알아보았습니다.
위 내용을 참고하여 RabbitMQ를 사용하여 다양한 서비스를 구축하시기 바랍니다.

감사합니다.
